{% extends "base.html" %}

{% block title %}
  {% if show_form %}
    –ó–∞–ª–∏—à—Ç–µ –≤—ñ–¥–≥—É–∫
  {% else %}
    –í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ —ñ–Ω—Å—Ç–∏—Ç—É—Ü—ñ—ó
  {% endif %}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6">

    {% if show_form %}
      <h2>–ó–∞–ª–∏—à—Ç–µ –≤—ñ–¥–≥—É–∫ –¥–ª—è: <strong>{{ official_name }}</strong></h2>
      <form action="/submit" method="post" class="border p-4 bg-white rounded shadow-sm">
        <input type="hidden" name="institution_code" value="{{ institution_code }}">
        <div class="mb-3">
          <label for="text">–í—ñ–¥–≥—É–∫</label>
          <textarea id="text" name="text" class="form-control" rows="6" required></textarea>
        </div>
        <button type="submit" class="btn btn-success">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
      </form>
    {% else %}
      <h2>–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ —ñ–Ω—Å—Ç–∏—Ç—É—Ü—ñ—ó –∞–±–æ –≤—ñ–¥—Å–∫–∞–Ω—É–π—Ç–µ QR-–∫–æ–¥</h2>
      <form action="/enter_code" method="post" class="border p-4 bg-white rounded shadow-sm mb-4">
        <div class="mb-3 d-flex align-items-center gap-2">
          <input type="text" id="code-input" name="code" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∞–±–æ —Å–∫–∞–Ω—É–π—Ç–µ" required autocomplete="off" />
          <button type="button" class="btn btn-outline-secondary" id="start-qr-scan-btn" title="–°–∫–∞–Ω—É–≤–∞—Ç–∏ QR –∫–æ–¥">üì∑</button>
        </div>
        {% if error %}
          <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
        <button type="submit" class="btn btn-primary w-100">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
      </form>

      <div id="qr-reader" style="display:none; width: 100%; max-width: 400px; margin: auto; border: 1px solid #ddd; border-radius: 8px;"></div>
      <div id="qr-result" class="text-center mt-3 text-muted"></div>
    {% endif %}

  </div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  let html5QrCode;
  const qrReaderDiv = document.getElementById('qr-reader');
  const qrResultDiv = document.getElementById('qr-result');
  const codeInput = document.getElementById('code-input');
  const startScanBtn = document.getElementById('start-qr-scan-btn');

function onScanSuccess(decodedText, decodedResult) {
  codeInput.value = decodedText;
  qrResultDiv.innerText = `–°–∫–∞–Ω–æ–≤–∞–Ω–æ: ${decodedText}`;
  stopScanning();

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ñ–æ—Ä–º—É
  const form = codeInput.closest('form');
  if (form) {
    form.submit();
  }
}


  function onScanFailure(error) {
    // –ü–æ–º–∏–ª–∫–∏ —ñ–≥–Ω–æ—Ä—É—î–º–æ
  }

  function stopScanning() {
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        html5QrCode.clear();
        qrReaderDiv.style.display = 'none';
        qrResultDiv.innerText = '';
      }).catch(err => {
        console.error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑—É–ø–∏–Ω–∏—Ç–∏ —Å–∫–∞–Ω–µ—Ä', err);
      });
    }
  }

  startScanBtn.addEventListener('click', () => {
    if (!html5QrCode) {
      html5QrCode = new Html5Qrcode("qr-reader");
    }

    if (qrReaderDiv.style.display === 'block') {
      stopScanning();
      return;
    }

    qrReaderDiv.style.display = 'block';
    qrResultDiv.innerText = '–û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è...';

    // –°–ø—Ä–æ–±–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∑–∞–¥–Ω—é –∫–∞–º–µ—Ä—É —á–µ—Ä–µ–∑ facingMode
    html5QrCode.start(
      { facingMode: { exact: "environment" } },
      { fps: 10, qrbox: 250 },
      onScanSuccess,
      onScanFailure
    ).catch(() => {
      // –Ø–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—å, –ø–∞–¥–∞—î–º–æ –Ω–∞ –ø–µ—Ä—à—É –∫–∞–º–µ—Ä—É
      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          html5QrCode.start(
            cameras[0].id,
            { fps: 10, qrbox: 250 },
            onScanSuccess,
            onScanFailure
          ).catch(err => {
            qrResultDiv.innerText = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É –∫–∞–º–µ—Ä–∏: ' + err;
            qrReaderDiv.style.display = 'none';
            console.error(err);
          });
        } else {
          qrResultDiv.innerText = '–ö–∞–º–µ—Ä–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞';
          qrReaderDiv.style.display = 'none';
        }
      }).catch(err => {
        qrResultDiv.innerText = '–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏: ' + err;
        qrReaderDiv.style.display = 'none';
        console.error(err);
      });
    });
  });
</script>
{% endblock %}
